<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Uninote - Notas JerÃ¡rquicas</title>

  <!-- CSS Modules -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/notes.css">
  <link rel="stylesheet" href="css/modals.css">
  <link rel="stylesheet" href="css/pickers.css">
  <link rel="stylesheet" href="css/archive.css">
  <link rel="stylesheet" href="css/search.css">
  <link rel="stylesheet" href="css/animations.css">
  <link rel="stylesheet" href="css/utilities.css">

  <!-- Pre-load lock check - Execute BEFORE any rendering -->
  <style id="pre-lock-style">
    /* Hidden by default, will be removed if not locked */
    body.pre-locked main,
    body.pre-locked header,
    body.pre-locked aside {
      display: none !important;
    }
    body.pre-locked #app-lock-modal-overlay {
      display: flex !important;
    }
  </style>
  <script>
    (function() {
      // Check if app was manually locked
      const wasLocked = sessionStorage.getItem('appManuallyLocked') === 'true';
      if (wasLocked) {
        console.log('ğŸ” PRE-LOCK: App was locked, applying pre-lock class');
        document.documentElement.classList.add('pre-locked');
        document.body.classList.add('pre-locked');
      } else {
        console.log('ğŸ”“ PRE-LOCK: App was not locked, removing pre-lock style');
        // Remove the pre-lock style if not locked
        window.addEventListener('DOMContentLoaded', function() {
          const style = document.getElementById('pre-lock-style');
          if (style) style.remove();
        });
      }
    })();
  </script>
</head>
<body>

  <!-- App Lock Overlay -->
  <div id="app-lock-overlay" class="hidden">
    <div class="app-lock-box">
        <h2 style="color: var(--primary-color); margin-top: 0;">AplicaciÃ³n Bloqueada</h2>
        <div class="form-field">
            <label for="app-lock-password-input">Introduce la contraseÃ±a para continuar</label>
            <input type="password" id="app-lock-password-input">
        </div>
        <div class="modal-actions" style="margin-top: 1rem;">
            <button id="app-lock-unlock-btn" class="modal-button confirm-action">Desbloquear</button>
        </div>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="document-title-container">
        <h1 id="document-title">Uninote â–¾</h1>
        <ul id="document-menu" class="hidden"></ul>
    </div>
    <div class="search-container">
        <input type="search" id="search-input" placeholder="Buscar en este Uninote...">
        <div class="global-search-toggle">
            <input type="checkbox" id="search-all-toggle">
            <label for="search-all-toggle">Buscar en todos</label>
        </div>
        <div id="notes-counter">Principales: 0 / Total: 0</div>
    </div>
    <div class="header-actions">
        <button id="relock-doc-btn" class="hidden" title="Volver a bloquear el Uninote">ğŸ”’ Bloquear Uninote</button>
        <button id="toggle-archive-view-btn" title="Ver Archivo">ğŸ“¦ Archivo</button>
        <button id="notification-center-btn" title="Centro de Notificaciones">
            <span>ğŸ””</span>
            <span id="notification-dot" class="hidden"></span>
        </button>
        <button id="app-settings-btn" title="Ajustes de la App">âš™ï¸</button>
        <button id="theme-toggle-btn" title="Cambiar tema">ğŸŒ™</button>
        <button id="help-btn" title="Ayuda y Atajos">?</button>
        <button id="toggle-all-btn" title="Contraer/Expandir todas las notas">Contraer Todo</button>
        <div class="transfer-menu-container">
            <button id="transfer-btn">Transferir v4.12 âš™ï¸â‹® â–¾</button>
            <ul id="transfer-menu" class="hidden">
                <li data-action="export-current">ğŸ“¤ Exportar Uninote Actual</li>
                <li data-action="export-total">ğŸ“¤ Exportar Backup Total</li>
                <hr>
                <li>
                    <label for="import-file-input">ğŸ“¥ Importar desde Archivo...</label>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;"/>
                </li>
                 <li>
                    <label for="import-notion-input">ğŸ“„ Importar de Notion...</label>
                    <input type="file" id="import-notion-input" accept=".md,.txt" style="display: none;"/>
                </li>
            </ul>
        </div>
        <button id="add-main-note-btn">Agregar Nota Principal</button>
    </div>
  </header>

  <!-- Tabs Container -->
  <div id="tabs-container"></div>

  <!-- Main Content Area -->
  <main>
    <ul id="notes-list"></ul>
    <div id="archive-view-container" class="hidden">
        <div id="archive-controls">
            <div>
                <label for="archive-sort-select">Ordenar por:</label>
                <select id="archive-sort-select">
                    <option value="archivedTimestamp">Fecha de Archivado</option>
                    <option value="creationDate">Fecha de CreaciÃ³n</option>
                    <option value="dueDate">Fecha LÃ­mite</option>
                </select>
            </div>
            <div class="archive-view-options">
                <label>Ver por:</label>
                <input type="radio" id="view-by-uninote" name="archive-view" value="groupByUninote" checked>
                <label for="view-by-uninote">Uninote</label>
                <input type="radio" id="view-by-date" name="archive-view" value="groupByDate">
                <label for="view-by-date">Fecha</label>
            </div>
        </div>
        <div id="archive-timeline-container"></div>
    </div>
    <ul id="global-search-results" class="hidden"></ul>
  </main>

  <!-- Icon Picker -->
  <div id="icon-picker" class="picker">
    <div class="picker-tabs">
        <button data-tab="common" title="MÃ¡s Usados">â­</button>
        <button data-tab="recents" title="Recientes">ğŸ•’</button>
        <button data-tab="smileys" title="Emoticonos y Personas">ğŸ˜€</button>
        <button data-tab="animals" title="Animales y Naturaleza">ğŸ»</button>
        <button data-tab="food" title="Comida y Bebida">ğŸ”</button>
        <button data-tab="activities" title="Actividades">âš½</button>
        <button data-tab="objects" title="Objetos">ğŸ’¡</button>
        <button data-tab="symbols" title="SÃ­mbolos">â¤ï¸</button>
    </div>
    <div class="picker-panels">
        <div class="picker-panel active" id="panel-common"></div>
        <div class="picker-panel" id="panel-recents"></div>
        <div class="picker-panel" id="panel-smileys"></div>
        <div class="picker-panel" id="panel-animals"></div>
        <div class="picker-panel" id="panel-food"></div>
        <div class="picker-panel" id="panel-activities"></div>
        <div class="picker-panel" id="panel-objects"></div>
        <div class="picker-panel" id="panel-symbols"></div>
    </div>
  </div>

  <!-- Context Menu -->
  <div id="context-menu" class="picker">
      <button id="remove-icon-btn">âŒ Quitar Icono</button>
  </div>

  <!-- Lock Menu -->
  <div id="lock-menu" class="picker">
    <button data-action="lock-universal">ğŸ”’ Bloquear con C. Universal</button>
    <button data-action="lock-document">ğŸ”’ Bloquear con C. de Uninote</button>
    <button data-action="lock-exclusive">ğŸ” Crear Bloqueo Exclusivo</button>
    <hr>
    <button data-action="unlock">ğŸ”“ Desbloquear</button>
    <button data-action="relock">ğŸ”’ Volver a Bloquear</button>
    <button data-action="remove-lock">âŒ Quitar Bloqueo</button>
  </div>

  <!-- Overflow Menu (botones ocultos) -->
  <div id="overflow-menu" class="picker" style="display: none;">
    <!-- Se rellena dinÃ¡micamente con botones ocultos -->
  </div>

  <!-- Formatting Toolbar -->
  <div id="formatting-toolbar" class="picker">
    <button data-command="bold" title="Negrita (Ctrl+B)">B</button>
    <input type="color" data-command="foreColor" title="Color de texto">
    <button data-command="decreaseFontSize" title="Disminuir tamaÃ±o">-</button>
    <input type="number" id="font-size-input" min="12" max="24" title="TamaÃ±o de fuente (px)">
    <button data-command="increaseFontSize" title="Aumentar tamaÃ±o">+</button>
  </div>

  <!-- Notification Area -->
  <div id="notification-area"></div>

  <!-- MODALS -->
  <div id="unarchive-modal-overlay" class="modal-overlay hidden">
    <div class="modal-box">
        <h2 id="unarchive-title">Desarchivar Nota</h2>
        <p>Â¿A dÃ³nde deseas mover esta nota?</p>
        <div class="modal-actions" style="flex-direction: column; align-items: stretch;">
            <button id="unarchive-to-original-btn" class="modal-button confirm-action"></button>
            <button id="unarchive-to-other-btn" class="modal-button">Elegir otro Uninote...</button>
            <ul id="unarchive-options-list" class="hidden"></ul>
        </div>
         <div class="modal-actions" style="margin-top: 1rem;">
            <button id="unarchive-cancel-btn" class="modal-button cancel-action">Cancelar</button>
        </div>
    </div>
  </div>

  <div id="confirmation-modal-overlay" class="modal-overlay hidden">
    <div class="modal-box">
        <h2 id="confirmation-title">Confirmar AcciÃ³n</h2>
        <p id="confirmation-message">Â¿EstÃ¡s seguro?</p>
        <div class="modal-actions">
            <button id="confirmation-confirm-btn" class="modal-button confirm-delete">Confirmar</button>
            <button id="confirmation-cancel-btn" class="modal-button cancel-action">Cancelar</button>
        </div>
    </div>
  </div>

  <div id="prompt-modal-overlay" class="modal-overlay hidden">
    <div class="modal-box">
        <h2 id="prompt-title">Input Required</h2>
        <p id="prompt-message">Please enter a value:</p>
        <input type="text" id="prompt-input">
        <div class="modal-actions">
            <button id="prompt-confirm-btn" class="modal-button">Confirmar</button>
            <button id="prompt-cancel-btn" class="modal-button cancel-action">Cancelar</button>
        </div>
    </div>
  </div>

  <div id="alert-modal-overlay" class="modal-overlay hidden">
      <div class="modal-box">
          <h2 id="alert-title">Alerta</h2>
          <p id="alert-message">This is an alert.</p>
          <div class="modal-actions">
              <button id="alert-ok-btn" class="modal-button">OK</button>
          </div>
      </div>
  </div>

  <div id="import-modal-overlay" class="modal-overlay hidden">
    <div class="modal-box">
        <h2 id="import-title">Importar Archivo</h2>
        <p id="import-message"></p>
        <div class="modal-actions">
            <button id="import-action-replace" class="modal-button confirm-delete"></button>
            <button id="import-action-append" class="modal-button"></button>
            <button id="import-action-merge" class="modal-button confirm-action"></button>
            <button id="import-action-cancel" class="modal-button cancel-action">Cancelar</button>
        </div>
    </div>
  </div>

  <div id="duplicate-modal-overlay" class="modal-overlay hidden">
    <div class="modal-box">
        <h2>Duplicar Nota</h2>
        <p>Â¿CÃ³mo deseas duplicar esta nota?</p>
        <div class="modal-actions" style="flex-direction: column; align-items: stretch;">
            <button id="duplicate-only-note-btn" class="modal-button confirm-action">ğŸ“ Duplicar solo esta nota</button>
            <button id="duplicate-with-children-btn" class="modal-button">ğŸ“‹ Duplicar con todas sus sub-notas</button>
            <button id="duplicate-cancel-btn" class="modal-button cancel-action">Cancelar</button>
        </div>
    </div>
  </div>

  <div id="date-picker-modal-overlay" class="modal-overlay hidden">
    <div class="modal-box">
        <h2>Establecer Fecha LÃ­mite</h2>
        <div id="date-time-input-container">
            <input type="datetime-local" id="date-time-input">
        </div>
        <div class="modal-actions">
            <button id="remove-date-btn" class="modal-button confirm-delete">Quitar Fecha</button>
            <button id="save-date-btn" class="modal-button">Guardar</button>
            <button id="cancel-date-btn" class="modal-button cancel-action">Cancelar</button>
        </div>
    </div>
  </div>

  <div id="help-modal-overlay" class="modal-overlay hidden">
      <div id="help-modal" class="modal-box">
          <h2>Ayuda y Atajos de Teclado</h2>
          <ul>
              <li><strong>Enter:</strong> Crear una nueva nota al mismo nivel.</li>
              <li><strong>Shift + Enter:</strong> Crear un salto de lÃ­nea dentro de una nota.</li>
              <li><strong>Tab:</strong> Anidar una nota (convertirla en sub-nota).</li>
              <li><strong>Shift + Tab:</strong> Desanidar una nota.</li>
              <li><strong>Ctrl + B:</strong> Aplicar/quitar negrita al texto seleccionado.</li>
              <li><strong>Ctrl + Flecha Arriba:</strong> Mover nota hacia arriba.</li>
              <li><strong>Ctrl + Flecha Abajo:</strong> Mover nota hacia abajo.</li>
              <li><strong>Arrastrar â ¿:</strong> Mover o anidar notas.</li>
              <li><strong>Clic en ğŸ”’:</strong> Opciones de bloqueo de nota.</li>
          </ul>
          <div class="modal-actions">
              <button id="help-close-btn" class="modal-button">Cerrar</button>
          </div>
      </div>
  </div>

  <div id="notification-center-overlay" class="modal-overlay hidden">
      <div id="notification-center-modal" class="modal-box">
          <h2>Centro de Notificaciones</h2>
          <ul id="notification-list">
          </ul>
          <div class="modal-actions">
              <button id="notification-center-close-btn" class="modal-button">Cerrar</button>
          </div>
      </div>
  </div>

  <!-- Security Modals -->
  <div id="app-settings-modal-overlay" class="modal-overlay hidden">
      <div id="app-settings-modal" class="modal-box">
          <h2>Ajustes de la AplicaciÃ³n</h2>

          <!-- Button Configuration Section (PRIMERO) -->
          <div id="button-config-section">
              <h3 style="margin-bottom: 15px;">âš™ï¸ ConfiguraciÃ³n de Botones</h3>

              <!-- Preset Modes -->
              <div class="form-field">
                  <label>Modos Predefinidos y Personalizados</label>
                  <div class="preset-modes" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                      <!-- Buttons rendered dynamically by buttonConfigEvents.js -->
                  </div>
              </div>

              <!-- NumeraciÃ³n Options -->
              <div class="form-field">
                  <label>PosiciÃ³n de NumeraciÃ³n</label>
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                      <label style="font-weight: normal; cursor: pointer;">
                          <input type="radio" name="numeracion" value="sin-numeracion">
                          Sin numeraciÃ³n
                      </label>
                      <label style="font-weight: normal; cursor: pointer;">
                          <input type="radio" name="numeracion" value="antes-contenido" checked>
                          Antes del contenido (por defecto)
                      </label>
                      <label style="font-weight: normal; cursor: pointer;">
                          <input type="radio" name="numeracion" value="antes-checkbox">
                          Antes del checkbox (#3 â˜‘ â ¿)
                      </label>
                  </div>
              </div>

              <!-- Menu Display Option -->
              <div class="form-field">
                  <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                      <input type="checkbox" id="menu-show-text-toggle" style="margin-right: 8px;">
                      Mostrar texto en menÃº de desbordamiento (â‹®)
                  </label>
              </div>

              <!-- Button Configuration Grid -->
              <div class="form-field">
                  <label>ConfiguraciÃ³n de Botones</label>
                  <p style="font-size: 0.9em; color: var(--text-muted, #666); margin-bottom: 10px;">
                      Arrastra los botones para reordenarlos. Click en ğŸ‘ï¸ para mostrar/ocultar.
                  </p>

                  <div id="button-config-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                      <!-- Left Column -->
                      <div>
                          <h4 style="margin-bottom: 10px; font-size: 0.95em;">Botones Izquierdos</h4>
                          <div id="left-buttons-container" class="buttons-container" data-column="left" style="min-height: 100px; border: 1px dashed var(--border-color); border-radius: 5px; padding: 10px;">
                              <!-- Buttons will be rendered here -->
                          </div>
                      </div>

                      <!-- Right Column -->
                      <div>
                          <h4 style="margin-bottom: 10px; font-size: 0.95em;">Botones Derechos</h4>
                          <div id="right-buttons-container" class="buttons-container" data-column="right" style="min-height: 100px; border: 1px dashed var(--border-color); border-radius: 5px; padding: 10px;">
                              <!-- Buttons will be rendered here -->
                          </div>
                      </div>
                  </div>
              </div>

              <!-- Save Custom Mode -->
              <div class="form-field">
                  <div style="display: flex; gap: 10px;">
                      <button id="update-current-mode-btn" class="modal-button" style="display: none;">âœï¸ Actualizar Modo Actual</button>
                      <button id="save-custom-mode-btn" class="modal-button confirm-action">ğŸ’¾ Guardar como Nuevo Modo</button>
                  </div>
              </div>
          </div>

          <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">

          <!-- App Lock Section (MOVIDO AL MEDIO) -->
          <div class="app-lock-toggle">
               <input type="checkbox" id="app-lock-enable-toggle">
               <label for="app-lock-enable-toggle">Activar Bloqueo Total de la App</label>
           </div>

           <div style="margin: 10px 0;">
               <button id="lock-app-now-btn" class="modal-button" style="width: 100%;">ğŸ”’ Bloquear App Ahora</button>
           </div>

           <div class="form-field" id="app-lock-password-container">
                <label for="app-lock-master-password-input">ContraseÃ±a de Bloqueo Total</label>
                <div class="password-field-container">
                    <input type="password" id="app-lock-master-password-input" readonly>
                    <div class="modal-actions">
                        <button id="app-lock-create-btn" class="modal-button confirm-action">Crear ContraseÃ±a</button>
                        <button id="app-lock-change-btn" class="modal-button">Cambiar ContraseÃ±a</button>
                        <button id="app-lock-remove-btn" class="modal-button confirm-delete">Quitar ContraseÃ±a</button>
                    </div>
                </div>
            </div>

          <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">

          <!-- Universal Password Section (AL FINAL) -->
          <div class="form-field" id="universal-password-container">
              <label for="universal-password-input">ContraseÃ±a Universal (para Bloqueo RÃ¡pido de Notas)</label>
               <div class="password-field-container">
                    <input type="password" id="universal-password-input" readonly>
                    <div class="modal-actions">
                        <button id="universal-create-btn" class="modal-button confirm-action">Crear ContraseÃ±a</button>
                        <button id="universal-change-btn" class="modal-button">Cambiar ContraseÃ±a</button>
                        <button id="universal-remove-btn" class="modal-button confirm-delete">Quitar ContraseÃ±a</button>
                    </div>
                </div>
          </div>
          <div class="modal-actions">
              <button id="cancel-app-settings-btn" class="modal-button cancel-action">Cerrar</button>
          </div>
      </div>
  </div>

  <div id="set-password-modal-overlay" class="modal-overlay hidden">
      <div class="modal-box">
          <h2 id="set-password-title">Establecer ContraseÃ±a</h2>
          <div class="form-field">
              <label for="set-password-input">Nueva ContraseÃ±a</label>
              <input type="password" id="set-password-input">
          </div>
          <div class="form-field">
              <label for="set-password-confirm-input">Confirmar ContraseÃ±a</label>
              <input type="password" id="set-password-confirm-input">
          </div>
          <div class="form-field" id="set-password-hint-container">
              <label for="set-password-hint-input">Pista PÃºblica (Opcional, visible cuando estÃ© bloqueado)</label>
              <input type="text" id="set-password-hint-input" maxlength="100">
          </div>
          <div class="modal-actions">
              <button id="save-password-btn" class="modal-button confirm-action">Guardar</button>
              <button id="cancel-password-btn" class="modal-button cancel-action">Cancelar</button>
          </div>
      </div>
  </div>

  <div id="unlock-modal-overlay" class="modal-overlay hidden">
      <div class="modal-box">
          <h2 id="unlock-title">Desbloquear Contenido</h2>
          <div class="form-field">
              <label for="unlock-password-input">ContraseÃ±a</label>
              <input type="password" id="unlock-password-input">
          </div>
          <div class="modal-actions">
              <button id="unlock-confirm-btn" class="modal-button confirm-action">Aceptar</button>
              <button id="unlock-cancel-btn" class="modal-button cancel-action">Cancelar</button>
          </div>
      </div>
  </div>

  <!-- App Lock Modal - Full Screen Secure Lock -->
  <div id="app-lock-modal-overlay" class="modal-overlay" style="display: none; z-index: 99999; background-color: #1a1a1a; opacity: 1;">
      <div class="modal-box" style="max-width: 400px;">
          <h2>ğŸ”’ App Bloqueada</h2>
          <p style="text-align: center; margin: 15px 0;">Introduce tu contraseÃ±a de bloqueo total para desbloquear la aplicaciÃ³n</p>
          <div class="form-field">
              <label for="app-unlock-password-input">ContraseÃ±a</label>
              <input type="password" id="app-unlock-password-input">
          </div>
          <div class="modal-actions">
              <button id="app-unlock-confirm-btn" class="modal-button confirm-action">Desbloquear</button>
          </div>
      </div>
  </div>

  <!-- Bulk Actions Bar -->
  <div id="bulk-actions-bar">
    <span id="selection-counter">0 notas seleccionadas</span>
    <button id="select-children-btn" title="Seleccionar todas las sub-notas de las notas seleccionadas">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Seleccionar Descendientes</button>
    <button id="indent-selected-btn" title="Anidar seleccionadas (Tab)">Anidar â†’</button>
    <button id="outdent-selected-btn" title="Desanidar seleccionadas (Shift+Tab)">â† Desanidar</button>
    <button id="delete-selected-btn">Eliminar Seleccionadas</button>
    <button id="deselect-all-btn">Deseleccionar Todo</button>
  </div>

  <!-- Scroll Buttons -->
  <div id="scroll-buttons">
      <button id="scroll-top-btn" class="scroll-btn" title="Ir al inicio">â†‘</button>
      <button id="scroll-bottom-btn" class="scroll-btn" title="Ir al final">â†“</button>
  </div>

  <!-- JavaScript Libraries -->
  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>

  <!-- JavaScript Modules (ES6 Modules) -->
  <script type="module" src="js/app.js"></script>
</body>
</html>
